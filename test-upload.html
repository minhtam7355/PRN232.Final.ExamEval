<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submission Processing - Real-time Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.14/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        .upload-section.dragging {
            background: #e0e7ff;
            border-color: #4c51bf;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: inline-block;
            transition: transform 0.2s;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .selected-file {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .upload-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .upload-btn:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .upload-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .queue-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .queue-info.show {
            display: block;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
        }

        .progress-section.show {
            display: block;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-queued {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-done {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .progress-bar-container {
            background: #e5e7eb;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .current-student {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .current-student strong {
            color: #667eea;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .students-table thead {
            background: #f9fafb;
        }

        .students-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .students-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .students-table tr:hover {
            background: #f9fafb;
        }

        .student-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .student-pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        .student-processing {
            background: #dbeafe;
            color: #1e40af;
            animation: pulse 2s infinite;
        }

        .student-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .student-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .violations {
            font-size: 12px;
            color: #dc2626;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-card.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .summary-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .summary-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .summary-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .summary-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .connection-status.connected {
            background: #10b981;
            color: white;
        }

        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .connection-status.connecting {
            background: #f59e0b;
            color: white;
        }

        .logs {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-time {
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        ‚ö´ Disconnected
    </div>

    <div class="container">
        <div class="header">
            <h1>üì¶ Submission Processing System</h1>
            <p>Upload student submissions and track processing in real-time</p>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <h2>üì§ Upload Submission Archive</h2>
                <p style="color: #666; margin: 15px 0;">Select a .zip or .rar file containing student submissions</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".zip,.rar">
                    <label for="fileInput" class="file-label">Choose File</label>
                </div>
                
                <div class="selected-file" id="selectedFile">No file selected</div>
                
                <button class="upload-btn" id="uploadBtn" disabled>
                    üöÄ Upload & Process
                </button>
            </div>

            <!-- Queue Info -->
            <div class="queue-info" id="queueInfo">
                <strong>‚è≥ Job Queued</strong>
                <p id="queueMessage">Your job is in the queue. Position: <span id="queuePosition">-</span></p>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <div class="progress-header">
                    <div>
                        <h2>üìä Processing Progress</h2>
                        <span class="status-badge" id="statusBadge">Processing</span>
                    </div>
                    <div class="progress-stats">
                        <div class="stat">
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statCompleted">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statFailed">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                    </div>
                </div>

                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>

                <div class="current-student" id="currentStudent">
                    <strong>Current:</strong> <span id="currentStudentName">Starting...</span>
                </div>

                <!-- Students Table -->
                <h3>üë• Students Processing Status</h3>
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Violations</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">
                                Waiting for data...
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Summary Cards (shown when completed) -->
                <div class="summary-cards" id="summaryCards" style="display: none;">
                    <div class="summary-card success">
                        <h3 id="summaryPassed">0</h3>
                        <p>‚úÖ Passed</p>
                    </div>
                    <div class="summary-card warning">
                        <h3 id="summaryWarning">0</h3>
                        <p>‚ö†Ô∏è Warning</p>
                    </div>
                    <div class="summary-card danger">
                        <h3 id="summaryFailed">0</h3>
                        <p>‚ùå Failed</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="summaryRate">0%</h3>
                        <p>Success Rate</p>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="logs" id="logs">
                <div class="log-entry">
                    <span class="log-time">[00:00:00]</span> System ready
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5000';
        const HUB_URL = `${API_BASE_URL}/hubs/progress`;

        // State
        let connection = null;
        let currentFolderId = null;
        let selectedFile = null;

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const selectedFileDiv = document.getElementById('selectedFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadSection = document.getElementById('uploadSection');
        const queueInfo = document.getElementById('queueInfo');
        const progressSection = document.getElementById('progressSection');
        const connectionStatus = document.getElementById('connectionStatus');
        const logs = document.getElementById('logs');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupFileInput();
            setupDragDrop();
            connectSignalR();
        });

        // File Input Setup
        function setupFileInput() {
            fileInput.addEventListener('change', (e) => {
                selectedFile = e.target.files[0];
                if (selectedFile) {
                    selectedFileDiv.textContent = `Selected: ${selectedFile.name} (${formatBytes(selectedFile.size)})`;
                    uploadBtn.disabled = false;
                    log(`File selected: ${selectedFile.name}`);
                }
            });

            uploadBtn.addEventListener('click', uploadFile);
        }

        // Drag & Drop
        function setupDragDrop() {
            const uploadArea = uploadSection;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragging');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragging');
                }, false);
            });

            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    selectedFile = files[0];
                    selectedFileDiv.textContent = `Selected: ${selectedFile.name} (${formatBytes(selectedFile.size)})`;
                    uploadBtn.disabled = false;
                    log(`File dropped: ${selectedFile.name}`);
                }
            }, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // SignalR Connection
        async function connectSignalR() {
            updateConnectionStatus('connecting');
            log('Connecting to SignalR hub...');

            connection = new signalR.HubConnectionBuilder()
                .withUrl(HUB_URL)
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            // Event: Progress Update
            connection.on('ProgressUpdate', (progress) => {
                log(`Progress update: ${progress.completed}/${progress.total}`);
                updateProgress(progress);
            });

            // Event: Queue Update
            connection.on('QueueUpdate', (queueInfo) => {
                log(`Queue updated: ${queueInfo.queueLength} jobs in queue`);
            });

            // Event: Job Started
            connection.on('JobStarted', (data) => {
                log(`Job started: ${data.folderId}`);
                queueInfo.classList.remove('show');
                progressSection.classList.add('show');
            });

            try {
                await connection.start();
                updateConnectionStatus('connected');
                log('‚úÖ Connected to SignalR hub');
            } catch (err) {
                updateConnectionStatus('disconnected');
                log(`‚ùå Connection failed: ${err}`, 'error');
                setTimeout(connectSignalR, 5000);
            }

            connection.onreconnecting(() => {
                updateConnectionStatus('connecting');
                log('‚ö†Ô∏è Reconnecting...');
            });

            connection.onreconnected(() => {
                updateConnectionStatus('connected');
                log('‚úÖ Reconnected');
                if (currentFolderId) {
                    connection.invoke('SubscribeToJob', currentFolderId);
                }
            });

            connection.onclose(() => {
                updateConnectionStatus('disconnected');
                log('‚ùå Connection closed');
            });
        }

        // Upload File
        async function uploadFile() {
            if (!selectedFile) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';
            log(`Uploading ${selectedFile.name}...`);

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch(`${API_BASE_URL}/api/submissions/run`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                currentFolderId = result.folderId;

                log(`‚úÖ Upload successful! FolderId: ${currentFolderId}`);
                log(`Status: ${result.status}`);

                if (result.status === 'queued') {
                    // Job is queued
                    queueInfo.classList.add('show');
                    document.getElementById('queuePosition').textContent = result.queuePosition;
                    document.getElementById('queueMessage').textContent = 
                        `Your job is in the queue. Position: ${result.queuePosition}. Please wait...`;
                } else {
                    // Job started immediately
                    progressSection.classList.add('show');
                }

                // Subscribe to this job
                if (connection.state === signalR.HubConnectionState.Connected) {
                    await connection.invoke('SubscribeToJob', currentFolderId);
                    log(`Subscribed to job: ${currentFolderId}`);
                }

            } catch (error) {
                log(`‚ùå Upload failed: ${error.message}`, 'error');
                alert('Upload failed: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Upload & Process';
            }
        }

        // Update Progress
        function updateProgress(progress) {
            // Update stats
            document.getElementById('statTotal').textContent = progress.total;
            document.getElementById('statCompleted').textContent = progress.completed;
            document.getElementById('statFailed').textContent = progress.failed;

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress.percentComplete}%`;
            progressBar.textContent = `${progress.percentComplete}%`;

            // Update current student
            if (progress.currentStudent) {
                document.getElementById('currentStudentName').textContent = progress.currentStudent;
            }

            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = progress.status.toUpperCase();
            statusBadge.className = 'status-badge status-' + progress.status;

            // Update students table
            if (progress.students) {
                updateStudentsTable(progress.students);
            }

            // If done, show summary
            if (progress.status === 'done') {
                log('‚úÖ Processing completed!');
                loadFinalReport();
            } else if (progress.status === 'failed') {
                log('‚ùå Processing failed!', 'error');
            }
        }

        // Update Students Table
        function updateStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            const studentArray = Object.entries(students).sort((a, b) => 
                a[0].localeCompare(b[0])
            );

            studentArray.forEach(([name, info]) => {
                const row = tbody.insertRow();
                
                // Student ID
                row.insertCell(0).textContent = name;
                
                // Status
                const statusCell = row.insertCell(1);
                const statusSpan = document.createElement('span');
                statusSpan.className = `student-status student-${info.status}`;
                statusSpan.textContent = info.status.toUpperCase();
                statusCell.appendChild(statusSpan);
                
                // Started
                row.insertCell(2).textContent = info.startedAt 
                    ? new Date(info.startedAt).toLocaleTimeString() 
                    : '-';
                
                // Completed
                row.insertCell(3).textContent = info.completedAt 
                    ? new Date(info.completedAt).toLocaleTimeString() 
                    : '-';
                
                // Violations
                const violationsCell = row.insertCell(4);
                if (info.violations && info.violations.length > 0) {
                    violationsCell.innerHTML = `<span class="violations">${info.violations.length} issues</span>`;
                } else {
                    violationsCell.textContent = '-';
                }
            });
        }

        // Load Final Report
        async function loadFinalReport() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/submissions/report/${currentFolderId}`);
                const report = await response.json();

                log('üìä Final report loaded');

                // Show summary cards
                document.getElementById('summaryCards').style.display = 'grid';
                document.getElementById('summaryPassed').textContent = report.summary.passed;
                document.getElementById('summaryWarning').textContent = report.summary.warning;
                document.getElementById('summaryFailed').textContent = report.summary.failed;
                document.getElementById('summaryRate').textContent = report.summary.successRate + '%';

                log(`Summary: ${report.summary.passed} passed, ${report.summary.warning} warnings, ${report.summary.failed} failed`);
            } catch (error) {
                log(`‚ùå Failed to load report: ${error.message}`, 'error');
            }
        }

        // Connection Status
        function updateConnectionStatus(status) {
            connectionStatus.className = `connection-status ${status}`;
            if (status === 'connected') {
                connectionStatus.innerHTML = 'üü¢ Connected';
            } else if (status === 'connecting') {
                connectionStatus.innerHTML = 'üü° Connecting...';
            } else {
                connectionStatus.innerHTML = 'üî¥ Disconnected';
            }
        }

        // Logger
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        // Utilities
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>

